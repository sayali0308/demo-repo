pipeline {
    agent any

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scmGit(
                    branches: [[name: '*/master']], 
                    extensions: [], 
                    userRemoteConfigs: [[url: 'https://github.com/hellokaton/java11-examples.git']]
                )
            }
        }

        stage('Build & Test') {
            steps {
                sh 'mvn clean verify'
            }
        }

        stage('Install & Fix Sonar CLI') {
            steps {
                sh '''
                # 1. Install scanner if not present
                if [ ! -d "/opt/sonar-scanner" ]; then
                    wget -O sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
                    sudo unzip -o -q sonar-scanner.zip
                    sudo mv --force sonar-scanner-5.0.1.3006-linux /opt/sonar-scanner
                    rm sonar-scanner.zip
                fi
                
                # 2. Remove the broken bundled JRE
                sudo rm -rf /opt/sonar-scanner/jre
                
                # 3. FIX: Link the system Java into the scanner folder
                # This makes the scanner 'think' it has a local JRE
                sudo mkdir -p /opt/sonar-scanner/jre/bin
                sudo ln -sf $(which java) /opt/sonar-scanner/jre/bin/java
                '''
            }
        }

        stage('Analyzing Code Quality') {
            steps {
                sh '''
                # Use the absolute path to the scanner
                /opt/sonar-scanner/bin/sonar-scanner \
                -Dsonar.projectKey=sayali0308 \
                -Dsonar.organization=sayali0308 \
                -Dsonar.sources=src/main/java/ \
                -Dsonar.java.binaries=target/classes \
                -Dsonar.host.url=https://sonarcloud.io \
                -Dsonar.login=c982a906c7a18b21e98c2ba558c611e06a9f3e55
                '''
            }
        }
    }
}
